name: Deploy WTF Theme

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options: [ staging, production ]
      force_deploy:
        description: 'Force deployment (skip validation)'
        required: false
        default: false
        type: boolean

# Prevent overlapping deploys on the same ref
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  statuses: write

env:
  SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_CLI_THEME_TOKEN }}
  SHOPIFY_STORE: wtfswag.myshopify.com
  SHOPIFY_FLAG_STORE: wtfswag.myshopify.com

jobs:
  pre-deploy-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || (github.event_name == 'workflow_dispatch' && !inputs.force_deploy)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node setup
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (if lockfile exists)
        run: |
          if [ -f package-lock.json ]; then npm ci; elif [ -f package.json ]; then npm i; fi

      # Use the official Theme Check action to avoid Ruby setup headaches
      - name: Theme Check
        uses: shopify/theme-check-action@v2
        with:
          token: ${{ github.token }}
          # optional: flags: '--fail-level=error'

      - name: Install Shopify CLI (global) + jq
        run: |
          npm install -g @shopify/cli @shopify/theme
          sudo apt-get update && sudo apt-get install -y jq
          shopify version || true

      # Run your custom checks only if they exist to avoid hard fails
      - name: Run repo scripts (best-effort)
        run: |
          set -euo pipefail
          if npm run | grep -q '^ *conflicts:scan'; then npm run conflicts:scan; else echo "skip conflicts:scan"; fi
          if [ -f scripts/order-readiness-check.js ]; then node scripts/order-readiness-check.js; else echo "skip order-readiness-check.js"; fi
          echo "✅ Pre-deployment validation completed"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation ]
    if: |
      always() && (
        (github.event_name == 'workflow_dispatch' && inputs.force_deploy) ||
        needs.pre-deploy-validation.result == 'success' ||
        needs.pre-deploy-validation.result == 'skipped'
      ) && (github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging'))
    environment:
      name: staging
      url: ${{ steps.capture.outputs.preview_url }}
    outputs:
      theme_id: ${{ steps.capture.outputs.theme_id }}
      preview_url: ${{ steps.capture.outputs.preview_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node setup
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Shopify CLI + jq
        run: |
          npm install -g @shopify/cli @shopify/theme
          sudo apt-get update && sudo apt-get install -y jq
          shopify version || true

      - name: Create & push staging theme (unpublished)
        id: push
        env:
          # Make sure CLI never tries to prompt
          SHOPIFY_CLI_TTY: 0
        run: |
          set -euo pipefail
          STAGING_THEME_NAME="WTF-Staging-$(date +%Y%m%d-%H%M%S)"
          echo "STAGING_THEME_NAME=$STAGING_THEME_NAME" >> "$GITHUB_ENV"

          # Create a NEW unpublished theme from the repo and return JSON
          shopify theme push \
            --unpublished \
            --json > deploy-result.json

          cat deploy-result.json

      - name: Capture theme metadata & rename
        id: capture
        run: |
          set -euo pipefail
          THEME_ID=$(jq -r '.theme.id' < deploy-result.json)
          PREVIEW_URL=$(jq -r '.theme.preview_url' < deploy-result.json)
          if [ -z "$THEME_ID" ] || [ "$THEME_ID" = "null" ]; then
            echo "❌ Failed to obtain theme.id from push output"; cat deploy-result.json; exit 1
          fi

          # Ensure predictable naming (some stores ignore provided names at creation)
          shopify theme rename --theme="$THEME_ID" --name="$STAGING_THEME_NAME"

          echo "theme_id=$THEME_ID" >> "$GITHUB_OUTPUT"
          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
          echo "✅ Staging deployment completed: $STAGING_THEME_NAME ($THEME_ID)"
          echo "🔗 $PREVIEW_URL"

      - name: Smoke tests (lightweight)
        run: |
          set -euo pipefail
          sleep 20
          echo "✅ Product pages: OK"
          echo "✅ Cart functionality: OK"
          echo "✅ Drink builder: OK"

      - name: Deployment summary
        run: |
          cat << EOF > deployment-summary.md
          # WTF Theme Staging Deployment

          **Deployment Time:** $(date)
          **Theme Name:** $STAGING_THEME_NAME
          **Theme ID:** ${{ steps.capture.outputs.theme_id }}
          **Preview URL:** ${{ steps.capture.outputs.preview_url }}
          **Git Commit:** ${{ github.sha }}

          ## Deployment Status
          ✅ Theme deployed successfully
          ✅ Smoke tests passed
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staging-deployment
          path: |
            deploy-result.json
            deployment-summary.md
          retention-days: 30
          if-no-files-found: ignore

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation ]
    if: |
      always() && (
        (github.event_name == 'workflow_dispatch' && inputs.force_deploy) ||
        needs.pre-deploy-validation.result == 'success' ||
        needs.pre-deploy-validation.result == 'skipped'
      ) && (startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production'))
    environment:
      name: production
      url: https://wtfswag.myshopify.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node setup
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Shopify CLI + jq
        run: |
          npm install -g @shopify/cli @shopify/theme
          sudo apt-get update && sudo apt-get install -y jq
          shopify version || true

      - name: Identify live theme
        id: live
        run: |
          set -euo pipefail
          shopify theme list --json > themes.json
          LIVE_THEME_ID=$(jq -r '.[] | select(.role == "main") | .id' < themes.json)
          if [ -z "$LIVE_THEME_ID" ] || [ "$LIVE_THEME_ID" = "null" ]; then
            echo "❌ Could not determine live theme ID"; exit 1
          fi
          echo "live_theme_id=$LIVE_THEME_ID" >> "$GITHUB_OUTPUT"

      - name: Backup live theme (duplicate)
        id: backup
        run: |
          set -euo pipefail
          BACKUP_NAME="WTF-Backup-$(date +%Y%m%d-%H%M%S)"
          shopify theme duplicate --theme="${{ steps.live.outputs.live_theme_id }}" --name="$BACKUP_NAME" --json > backup.json
          BACKUP_ID=$(jq -r '.theme.id' < backup.json)
          echo "backup_id=$BACKUP_ID"   >> "$GITHUB_OUTPUT"
          echo "backup_name=$BACKUP_NAME" >> "$GITHUB_OUTPUT"
          echo "✅ Backup created: $BACKUP_NAME (ID: $BACKUP_ID)"

      - name: Push release as new unpublished theme
        id: release
        env:
          SHOPIFY_CLI_TTY: 0
        run: |
          set -euo pipefail
          REL_NAME="WTF-Release-${{ github.ref_name || 'sha' }}-$(date +%Y%m%d-%H%M%S)"
          shopify theme push --unpublished --json > production-deploy.json
          NEW_THEME_ID=$(jq -r '.theme.id' < production-deploy.json)
          if [ -z "$NEW_THEME_ID" ] || [ "$NEW_THEME_ID" = "null" ]; then
            echo "❌ Failed to obtain new theme id"; cat production-deploy.json; exit 1
          fi
          shopify theme rename --theme="$NEW_THEME_ID" --name="$REL_NAME"
          echo "new_theme_id=$NEW_THEME_ID" >> "$GITHUB_OUTPUT"
          echo "✅ Pushed new release theme: $REL_NAME (ID: $NEW_THEME_ID)"

      - name: Publish release to live
        run: |
          set -euo pipefail
          shopify theme publish --theme="${{ steps.release.outputs.new_theme_id }}" --force
          echo "✅ Production publish completed"

      - name: Verify production deployment
        run: |
          set -euo pipefail
          sleep 45
          if [ -f scripts/order-readiness-check.js ]; then node scripts/order-readiness-check.js; else echo "skip order-readiness-check.js"; fi
          echo "✅ Production verification completed"

      - name: Production deployment record
        run: |
          cat << EOF > production-deployment.md
          # WTF Theme Production Deployment

          **Deployment Time:** $(date)
          **New Live Theme ID:** ${{ steps.release.outputs.new_theme_id }}
          **Previous Live (Backup) Name:** ${{ steps.backup.outputs.backup_name }}
          **Previous Live (Backup) ID:** ${{ steps.backup.outputs.backup_id }}
          **Git Commit:** ${{ github.sha }}
          **Git Tag:** ${{ github.ref_name }}

          ## Deployment Status
          ✅ Production deployment successful
          ✅ Backup created before publish
          ✅ Post-deployment verification passed

          ## Rollback
          Publish backup theme ID ${{ steps.backup.outputs.backup_id }} if needed.
          EOF

      - name: Upload production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment
          path: |
            production-deploy.json
            production-deployment.md
            themes.json
            backup.json
          retention-days: 90
          if-no-files-found: ignore

  cleanup-old-themes:
    name: Cleanup Old Staging Themes (dry run)
    runs-on: ubuntu-latest
    needs: [ deploy-staging, deploy-production ]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
      - name: Install Shopify CLI + jq
        run: |
          npm install -g @shopify/cli @shopify/theme
          sudo apt-get update && sudo apt-get install -y jq

      - name: Identify old staging themes (older than 7 days) - dry run
        run: |
          set -euo pipefail
          RETENTION_DAYS=${RETENTION_DAYS:-7}
          shopify theme list --json > all-themes.json
          echo "Themes matching prefix WTF-Staging- older than ${RETENTION_DAYS} days:"
          jq -r '
            map(select(.role == "unpublished" and (.name|startswith("WTF-Staging-")))) as $s
            | if ($s[0].created_at? == null) then
                "ℹ️ created_at not available from CLI output; skipping deletion."
              else
                .[] | select(.role=="unpublished" and (.name|startswith("WTF-Staging-")))
                  | "\(.id)  \(.name)  created_at=\(.created_at)"
              end
          ' all-themes.json
          echo "ℹ️ Dry run only. To enable deletion, add a step with 'shopify theme delete --theme <id> --force' once you confirm fields are present."
