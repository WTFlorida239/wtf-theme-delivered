# Lightspeed POS Sync Runbook

## Overview

This document outlines the process for synchronizing inventory, products, and orders between WTF's Lightspeed POS system and the Shopify store. This ensures accurate inventory levels and consistent product information across all sales channels.

## Middleware Service Overview

- **Source code**: `middleware/lightspeed-sync/handler.js`
- **Purpose**: Acts as the secure proxy between Shopify (via app proxy) and Lightspeed Retail. Handles inventory reads, reservations, inventory pushes back into Shopify, and completed order sync into Lightspeed.
- **Interface**: `https://wtfswag.myshopify.com/apps/wtf/lightspeed/*` (Shopify app proxy). All storefront requests must flow through this middleware—direct calls to Lightspeed or Shopify Admin are forbidden from the client.
- **Authentication**: Verifies Shopify proxy signatures (`signature` query param or `X-Shopify-Hmac-Sha256` header) using `SHOPIFY_PROXY_SHARED_SECRET`. Requests from unknown shops are rejected unless present in `ALLOWED_SHOPIFY_STORES`.
- **Secrets**: Lightspeed OAuth credentials, Shopify Admin API token, and proxy shared secret are injected as environment variables at deploy time (see **Secret Storage & Rotation** below).

## Prerequisites

- Access to Lightspeed POS admin panel
- Shopify admin access with inventory management permissions
- API credentials for both systems
- Backup of current inventory data

### Required Environment Variables

Set the following values in the hosting platform's secret manager before deploying the middleware:

| Variable | Description |
| --- | --- |
| `LIGHTSPEED_ACCOUNT_ID` | Lightspeed Retail account identifier. |
| `LIGHTSPEED_CLIENT_ID` / `LIGHTSPEED_CLIENT_SECRET` | OAuth client for the custom Lightspeed app. |
| `LIGHTSPEED_REFRESH_TOKEN` | Refresh token issued by Lightspeed for long-lived access. |
| `LIGHTSPEED_SHOP_ID` / `LIGHTSPEED_REGISTER_ID` | Target shop/register IDs for reservations and sale creation. |
| `SHOPIFY_STORE_DOMAIN` | `wtfswag.myshopify.com`. |
| `SHOPIFY_API_VERSION` | Admin API version (default `2024-04`). |
| `SHOPIFY_ADMIN_API_ACCESS_TOKEN` | Private Admin API access token with inventory + orders scope. |
| `SHOPIFY_PROXY_SHARED_SECRET` | Shared secret generated by the Shopify custom app proxy. |
| `SHOPIFY_LOCATION_ID` | Shopify location ID that receives inventory updates. |
| `ALLOWED_SHOPIFY_STORES` | Comma separated list of allowed shop domains (include `wtfswag.myshopify.com`). |

> ⚠️ Do **not** hardcode any credentials inside the repository or Shopify theme settings. Everything must originate from the secret manager so rotation does not require a code change.

## Deployment Workflow

### 1. Package Middleware for Deployment

1. Install dependencies:
   ```bash
   npm install
   ```
2. Bundle the handler (example using zip for AWS Lambda):
   ```bash
   zip -r lightspeed-sync.zip middleware/lightspeed-sync/ package.json package-lock.json
   ```

### 2. Deploy to Hosting Platform (example: AWS Lambda + API Gateway)

1. Create a new Lambda function (Node.js 18+) named `wtf-lightspeed-sync`.
2. Upload `lightspeed-sync.zip` and set the handler to `middleware/lightspeed-sync/handler.handler`.
3. Configure environment variables using the secret manager references (see next section).
4. Create an HTTP API Gateway with routes:
   - `GET /inventory`
   - `GET /availability`
   - `POST /reserve`
   - `PUT /reserve`
   - `POST /release`
   - `POST /sync`
   - `POST /orders`
5. Connect the API Gateway routes to the Lambda function.
6. Restrict access to Shopify's IP ranges if desired (optional but recommended).
7. Update the Shopify custom app proxy URL to point to the API Gateway endpoint (e.g., `https://{api-id}.execute-api.us-east-1.amazonaws.com/apps/wtf/lightspeed`).

> If using another platform (Cloudflare Workers, Fly.io, etc.), mirror the same environment variables and ensure HTTPS termination plus Shopify signature verification remain intact.

### 3. Wire Shopify Theme Configuration

1. In `config/settings_data.json`, ensure the Lightspeed integration block exposes `enabled`, `accountId`, and the middleware base URL (`/apps/wtf/lightspeed`).
2. Confirm `assets/wtf-lightspeed-integration.js` initializes only when `enabled` is true and the middleware endpoints respond with `200`.
3. Publish the theme to staging and trigger a smoke test (see **Post-Sync Verification**).

## Sync Process

### 1. Pre-Sync Preparation

#### Backup Current Data
```bash
# Export current Shopify inventory
curl -X GET "https://wtfswag.myshopify.com/admin/api/2023-10/inventory_levels.json" \
  -H "X-Shopify-Access-Token: YOUR_TOKEN" > shopify_inventory_backup.json

# Export Lightspeed inventory
# Use Lightspeed API or export from admin panel
```

#### Verify SKU Parity
1. **Export SKU lists from both systems**
   - Lightspeed: Admin → Products → Export
   - Shopify: Products → Export

2. **Compare SKU formats**
   - Ensure consistent SKU naming conventions
   - Map any discrepancies in SKU formats
   - Document any products that exist in one system but not the other

3. **Create SKU mapping file**
   ```json
   {
     "sku_mappings": {
       "KAVA-PREM-001": "kava-premium-small",
       "KRATOM-GRN-002": "kratom-green-medium",
       "THC-DRINK-003": "thc-beverage-10mg"
     },
     "unmapped_lightspeed": [],
     "unmapped_shopify": []
   }
   ```

### 2. Sandbox Sync Execution

#### Environment Setup
```bash
# Set environment variables
export LIGHTSPEED_API_KEY="your_lightspeed_api_key"
export LIGHTSPEED_ACCOUNT_ID="your_account_id"
export SHOPIFY_API_KEY="your_shopify_api_key"
export SHOPIFY_PASSWORD="your_shopify_password"
export SHOPIFY_STORE_URL="wtfswag.myshopify.com"

# Test API connections
curl -X GET "https://api.lightspeedapp.com/API/Account/${LIGHTSPEED_ACCOUNT_ID}/Item.json" \
  -H "Authorization: Bearer ${LIGHTSPEED_API_KEY}"

curl -X GET "https://${SHOPIFY_STORE_URL}/admin/api/2023-10/products/count.json" \
  -H "X-Shopify-Access-Token: ${SHOPIFY_API_KEY}"
```

#### Sync Script Execution
```bash
# Run the sync script in dry-run mode first
node scripts/lightspeed-sync.js --dry-run --environment=sandbox

# Review the sync plan
cat sync-plan-$(date +%Y%m%d).json

# Execute the actual sync
node scripts/lightspeed-sync.js --environment=sandbox --confirm
```

### 3. Data Validation

#### Inventory Verification
1. **Compare inventory levels**
   ```sql
   -- Sample queries to verify sync
   SELECT sku, lightspeed_qty, shopify_qty, 
          ABS(lightspeed_qty - shopify_qty) as difference
   FROM sync_validation 
   WHERE ABS(lightspeed_qty - shopify_qty) > 0;
   ```

2. **Product information validation**
   - Verify product titles match
   - Check pricing consistency
   - Validate product descriptions and images
   - Confirm category assignments

3. **Generate validation report**
   ```bash
   node scripts/sync-validation.js --generate-report
   ```

### 4. Fallback Procedures

#### If Sync Fails

1. **Immediate Actions**
   - Stop any automated sync processes
   - Restore from backup if data corruption occurred
   - Document the failure point and error messages

2. **Manual Sync Process**
   ```bash
   # Export critical products manually
   node scripts/manual-sync.js --products="kava,kratom,thc-beverages"
   
   # Update inventory for high-priority items
   node scripts/priority-inventory-update.js
   ```

3. **Rollback Procedure**
   ```bash
   # Restore Shopify inventory from backup
   node scripts/restore-inventory.js --backup-file=shopify_inventory_backup.json
   
   # Verify rollback success
   node scripts/verify-rollback.js
   ```

### 5. Post-Sync Verification

#### Automated Checks
```bash
# Run comprehensive validation
npm run sync:validate

# Check for orphaned records
npm run sync:check-orphans

# Verify pricing consistency
npm run sync:check-pricing
```

#### Manual Verification Checklist
- [ ] Top 10 selling products have correct inventory
- [ ] New products from Lightspeed appear in Shopify
- [ ] Discontinued products are properly handled
- [ ] Pricing matches between systems
- [ ] Product images and descriptions are intact
- [ ] Categories and tags are preserved

### 6. Monitoring and Alerts

#### Set Up Monitoring
```javascript
// Monitor sync health
const syncMonitor = {
  checkInterval: 300000, // 5 minutes
  alertThresholds: {
    inventoryDiscrepancy: 5,
    syncLatency: 600000, // 10 minutes
    errorRate: 0.05 // 5%
  }
};
```

#### Alert Channels
- **Slack**: `#wtf-inventory-alerts`
- **Email**: ops@wtfswag.com
- **SMS**: Critical failures only

## Troubleshooting

### Common Issues

#### SKU Mismatch
```bash
# Find SKU discrepancies
node scripts/find-sku-mismatches.js

# Generate SKU mapping suggestions
node scripts/suggest-sku-mappings.js
```

#### API Rate Limits
```javascript
// Implement exponential backoff
const retryWithBackoff = async (apiCall, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await apiCall();
    } catch (error) {
      if (error.status === 429) {
        const delay = Math.pow(2, i) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      throw error;
    }
  }
};
```

#### Inventory Sync Conflicts
1. **Identify conflict source**
   - Check recent sales in both systems
   - Verify manual adjustments
   - Review sync logs for errors

2. **Resolution priority**
   - Lightspeed POS is source of truth for in-store inventory
   - Shopify handles online-only products
   - Manual reconciliation for discrepancies > 10 units

### Error Codes

| Code | Description | Action |
|------|-------------|---------|
| LS001 | Lightspeed API timeout | Retry with exponential backoff |
| LS002 | SKU not found in Lightspeed | Check SKU mapping, create if needed |
| LS003 | Inventory lock conflict | Wait and retry, escalate if persistent |
| SH001 | Shopify rate limit exceeded | Implement request throttling |
| SH002 | Product variant limit reached | Consolidate variants or split products |
| SH003 | Invalid product data | Validate and clean data before sync |

## Maintenance Schedule

### Daily
- [ ] Monitor sync status dashboard
- [ ] Review error logs
- [ ] Verify critical product inventory

### Weekly
- [ ] Full inventory reconciliation
- [ ] Review SKU mapping accuracy
- [ ] Update sync configuration if needed

### Monthly
- [ ] Performance optimization review
- [ ] Update API credentials if needed
- [ ] Backup sync configuration

## Emergency Contacts

- **Primary**: Operations Manager - (239) 555-0100
- **Secondary**: IT Support - support@wtfswag.com
- **Escalation**: Store Manager - manager@wtfswag.com

## Documentation Updates

This runbook should be updated whenever:
- Sync process changes
- New error conditions are discovered
- API endpoints or credentials change
- Fallback procedures are modified

**Last Updated**: 2024-12-19
**Next Review**: 2025-01-19
**Version**: 1.0
## Secret Storage & Rotation

### Recommended Storage Locations

- **AWS Secrets Manager** (if hosting on AWS): store `LIGHTSPEED_*`, `SHOPIFY_ADMIN_API_ACCESS_TOKEN`, and `SHOPIFY_PROXY_SHARED_SECRET` as individual secrets or a JSON bundle. Grant the Lambda execution role read-only access.
- **Shopify App Proxy Settings**: manage the proxy shared secret under the custom app configuration; update `SHOPIFY_PROXY_SHARED_SECRET` whenever the secret changes.
- **Lightspeed OAuth Console**: rotate refresh tokens via the custom app dashboard; immediately update the secret store to avoid token expiry.

### Rotation Procedure

1. **Prepare new credentials**
   - Generate a new Lightspeed refresh token via the OAuth flow.
   - Create a new Shopify Admin API token if required (Apps → Custom apps → WTF Ops → Reveal token).
2. **Update secrets**
   - Write the new values into the secret manager (maintain previous values until the new deployment succeeds).
   - Update the Lambda environment variables to reference the new secret versions.
3. **Redeploy middleware**
   - Publish a new deployment (or trigger the Lambda to reload environment variables).
4. **Smoke test**
   - Call `GET /inventory` via the Shopify app proxy to confirm a 200 response.
   - Add an item to the cart on staging; ensure the reservation endpoint responds successfully.
5. **Invalidate caches / notify ops**
   - Post in `#wtf-inventory-alerts` with the rotation summary.
   - Remove old tokens from Lightspeed/Shopify dashboards to prevent reuse.

Document each rotation in `docs/runbooks/rotation-log.md` (create if missing) with date, operator, and ticket link.

