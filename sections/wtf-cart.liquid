{% comment %}
  WTF Cart Section (OS 2.0)
  - Renders cart items and summary
  - Delegates all cart interactions to /assets/wtf-cart-ui.js
  - Uses proper identifiers: line (1-based) and item.key for change.js calls
{% endcomment %}

<section id="wtf-cart" class="cart-section page-width" data-cart-section>
  {% if cart.item_count == 0 %}
    <div class="cart-empty">
      <h1 class="cart-empty__title">Your cart is empty</h1>
      <p class="cart-empty__text">Start building your perfect drink!</p>
      <a href="/collections/all" class="button">Start Shopping</a>
    </div>
  {% else %}
    <header class="cart-header">
      <h1 class="cart-title">
        Your Cart ({{ cart.item_count }} {{ cart.item_count == 1 ? 'item' : 'items' }})
      </h1>
    </header>

    <div class="cart-content">
      <div class="cart-items" data-cart-items>
        {% for item in cart.items %}
          <article class="cart-item"
                   data-line="{{ forloop.index }}"
                   data-key="{{ item.key }}"
                   data-variant-id="{{ item.variant.id }}">
            <div class="cart-item__image">
              {% if item.image %}
                <a href="{{ item.url }}">
                  <img
                    src="{{ item.image | image_url: width: 150 }}"
                    alt="{{ item.product.title | escape }}"
                    width="150" height="150" loading="lazy">
                </a>
              {% endif %}
            </div>

            <div class="cart-item__details">
              <h3 class="cart-item__title">
                <a href="{{ item.product.url }}">{{ item.product.title }}</a>
              </h3>
              {% if section.settings.show_vendor and item.product.vendor %}
                <p class="cart-item__vendor">{{ item.product.vendor }}</p>
              {% endif %}
              {% if item.variant.title != 'Default Title' %}
                <p class="cart-item__variant">{{ item.variant.title }}</p>
              {% endif %}

              {% if item.properties and item.properties.size > 0 %}
                <div class="cart-item__properties wtf-line__properties">
                  {% for property in item.properties %}
                    {% unless property.first contains '_' or property.last == blank %}
                      <div class="cart-item__property">
                        <strong>{{ property.first | replace: 'wtf_', '' | replace: '_', ' ' | capitalize }}:</strong>
                        {{ property.last }}
                      </div>
                    {% endunless %}
                  {% endfor %}
                </div>
              {% endif %}

              <p class="cart-item__price">
                {% if item.original_line_price != item.final_line_price %}
                  <span class="cart-item__price--compare">
                    {{ item.original_line_price | money_with_currency }}
                  </span>
                {% endif %}
                <span class="cart-item__price--final">
                  {{ item.final_line_price | money_with_currency }}
                </span>
              </p>
            </div>

            <div class="cart-item__controls">
              <div class="quantity-selector">
                <button type="button"
                        class="qty-btn"
                        data-action="decrease"
                        data-line="{{ forloop.index }}"
                        data-key="{{ item.key }}"
                        aria-label="Decrease quantity"
                        {% if item.quantity <= 1 %}disabled{% endif %}>âˆ’</button>

                <input type="number"
                       class="qty-input"
                       value="{{ item.quantity }}"
                       min="1" max="99"
                       inputmode="numeric"
                       data-line="{{ forloop.index }}"
                       data-key="{{ item.key }}"
                       aria-label="Quantity for {{ item.product.title }}">

                <button type="button"
                        class="qty-btn"
                        data-action="increase"
                        data-line="{{ forloop.index }}"
                        data-key="{{ item.key }}"
                        aria-label="Increase quantity">+</button>
              </div>

              <button type="button"
                      class="cart-remove"
                      data-action="remove"
                      data-line="{{ forloop.index }}"
                      data-key="{{ item.key }}"
                      aria-label="Remove {{ item.product.title }} from cart">
                Remove
              </button>
            </div>
          </article>
        {% endfor %}
      </div>

      <aside class="cart-summary">
        <div class="cart-summary__row">
          <span>Subtotal</span>
          <strong data-cart-subtotal>{{ cart.total_price | money_with_currency }}</strong>
        </div>

        {% if cart.total_discounts > 0 %}
          <div class="cart-summary__row cart-summary__row--discount">
            <span>Discounts</span>
            <strong>-{{ cart.total_discounts | money_with_currency }}</strong>
          </div>
        {% endif %}

        {% if section.settings.show_cart_note %}
          <div class="cart-summary__row cart-summary__row--note">
            <label for="CartSpecialInstructions">Order note</label>
            <textarea id="CartSpecialInstructions"
                      name="note"
                      rows="3"
                      form="CartNoteForm"
                      placeholder="Add a note to your order"></textarea>
            <form id="CartNoteForm" action="/cart" method="post"></form>
          </div>
        {% endif %}

        <div class="cart-summary__actions">
          <a href="/collections/all" class="button button--secondary">Continue Shopping</a>
          <form action="{{ routes.cart_url }}" method="post" class="cart-checkout-form" novalidate>
            <button type="submit" name="checkout" class="button button--primary">Proceed to Checkout</button>
          </form>
        </div>
      </aside>
    </div>
  {% endif %}
</section>

<link rel="preload" href="{{ 'wtf-cart-ui.js' | asset_url }}" as="script">
<script src="{{ 'wtf-cart-ui.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "WTF Cart",
  "settings": [
    { "type": "checkbox", "id": "show_vendor", "label": "Show vendor", "default": false },
    { "type": "checkbox", "id": "show_cart_note", "label": "Enable cart notes", "default": true }
  ],
  "presets": [{ "name": "WTF Cart" }]
}
{% endschema %}
