{%- comment -%}
  Central SEO & Social Head Meta System

  Usage: {% render 'seo-head' %}

  Features:
  - Dynamic title/description per template type
  - Canonical URLs with variant/query handling
  - Hreflang alternates (Markets/locales)
  - Open Graph + Twitter Cards (+ locale alternates)
  - Geo/local meta tags
  - Robots meta control (utility pages + pagination)
  - Fallbacks from metafields/settings
{%- endcomment -%}

{%- liquid
  ############################
  # TITLE
  ############################
  assign page_title = page_title | default: shop.name

  if template.name == 'index'
    assign page_title = "Cape Coral's Premier Kava Bar | " | append: shop.name | append: " | Best Kava Drinks & Kratom Teas in Southwest Florida"
  elsif template.name contains 'product'
    assign page_title = product.title | append: " | " | append: shop.name
    if product.metafields.seo.title != blank
      assign page_title = product.metafields.seo.title
    endif
  elsif template.name contains 'collection'
    assign page_title = collection.title | append: " | " | append: shop.name
    if collection.metafields.seo.title != blank
      assign page_title = collection.metafields.seo.title
    endif
  elsif template.name contains 'article'
    assign page_title = article.title | append: " | " | append: shop.name | append: " Blog"
  elsif template.name contains 'page'
    assign page_title = page.title | append: " | " | append: shop.name
    if page.metafields.seo.title != blank
      assign page_title = page.metafields.seo.title
    endif
  endif

  # Conservative truncate to avoid SERP truncation on narrow devices
  if page_title and page_title.size > 60
    assign page_title = page_title | truncate: 60, '...'
  endif

  ############################
  # DESCRIPTION
  ############################
  assign meta_desc = page_description | default: shop.description | strip_html | strip | truncate: 155

  if template.name == 'index'
    assign meta_desc = "Cape Coral's premier kava bar offering custom kava drinks, kratom teas, THC beverages, and sober nightlife. Located at 1520 SE 46th Ln, serving Cape Coral, Fort Myers, and Southwest Florida."
  elsif template.name contains 'product'
    if product.metafields.seo.description != blank
      assign meta_desc = product.metafields.seo.description | strip_html | strip | truncate: 155
    elsif product.description != blank
      assign meta_desc = product.description | strip_html | strip | truncate: 155
    endif
  elsif template.name contains 'collection'
    if collection.metafields.seo.description != blank
      assign meta_desc = collection.metafields.seo.description | strip_html | strip | truncate: 155
    elsif collection.description != blank
      assign meta_desc = collection.description | strip_html | strip | truncate: 155
    endif
  elsif template.name contains 'article'
    if article.excerpt != blank
      assign meta_desc = article.excerpt | strip_html | strip | truncate: 155
    elsif article.content != blank
      assign meta_desc = article.content | strip_html | strip | truncate: 155
    endif
  elsif template.name contains 'page'
    if page.metafields.seo.description != blank
      assign meta_desc = page.metafields.seo.description | strip_html | strip | truncate: 155
    elsif page.content != blank
      assign meta_desc = page.content | strip_html | strip | truncate: 155
    endif
  endif

  ############################
  # ROBOTS
  ############################
  # Default allow indexing
  assign robots_content = "index,follow"

  # Utility/Thin pages to noindex but follow links
  assign is_utility_page = false
  if template.name == 'search'
    assign is_utility_page = true
  elsif template.name == 'cart'
    assign is_utility_page = true
  elsif template.name contains 'customers'
    assign is_utility_page = true
  elsif request.path contains '/policies'
    assign is_utility_page = true
  elsif request.path == '/challenge'
    assign is_utility_page = true
  elsif request.path contains '/tools'
    assign is_utility_page = true
  elsif template.name == 'gift_card'
    assign is_utility_page = true
  elsif template.name == 'list-collections'
    assign is_utility_page = true
  endif

  # Optional: allow template suffix to force noindex (e.g., page.noindex.json)
  if template.suffix == 'noindex'
    assign is_utility_page = true
  endif

  if is_utility_page
    assign robots_content = "noindex,follow"
  endif

  # Paginated pages (page > 1) â†’ noindex,follow to avoid duplicate snippets
  if current_page and current_page > 1
    assign robots_content = "noindex,follow"
  endif

  ############################
  # SOCIAL IMAGE
  ############################
  # Prefer the most relevant entity image, fall back to theme setting (logo/og_default)
  assign og_img = settings.og_default
  if og_img == blank
    assign og_img = settings.logo
  endif

  if template.name contains 'product' and product.featured_image
    assign og_img = product.featured_image
  elsif template.name contains 'collection' and collection.image
    assign og_img = collection.image
  elsif template.name contains 'article' and article.image
    assign og_img = article.image
  endif
-%}

{%- comment %} Title & Description {%- endcomment -%}
<title>{{ page_title }}</title>
<meta name="description" content="{{ meta_desc | escape }}">

{%- comment %} Canonical URL {%- endcomment -%}
<link rel="canonical" href="{{ canonical_url }}">

{%- comment -%} Hreflang alternates (Markets/locales) {%- endcomment -%}
{%- if shop.published_locales and shop.published_locales.size > 1 -%}
  {%- for locale in shop.published_locales -%}
    <link rel="alternate"
          hreflang="{{ locale.iso_code | replace: '_','-' | downcase }}"
          href="{{ canonical_url | within: locale }}">
  {%- endfor -%}
  <link rel="alternate"
        hreflang="x-default"
        href="{{ canonical_url | within: shop.primary_locale }}">
{%- endif -%}

{%- comment %} Robots (single source of truth) {%- endcomment -%}
<meta name="robots" content="{{ robots_content }}">

{%- comment %} Geo/Local Meta Tags {%- endcomment -%}
<meta name="geo.region" content="US-FL">
<meta name="geo.placename" content="Cape Coral">
<meta name="geo.position" content="26.5629;-81.9495">
<meta name="ICBM" content="26.5629, -81.9495">

{%- comment %} Open Graph {%- endcomment -%}
<meta property="og:site_name" content="{{ shop.name }}">
<meta property="og:title" content="{{ page_title }}">
<meta property="og:description" content="{{ meta_desc | escape }}">
<meta property="og:url" content="{{ canonical_url }}">
<meta property="og:type" content="{% if template.name contains 'product' %}product{% elsif template.name contains 'article' %}article{% else %}website{% endif %}">
<meta property="og:locale" content="en_US">
{%- if shop.published_locales and shop.published_locales.size > 1 -%}
  {%- for locale in shop.published_locales -%}
    {%- assign og_locale = locale.iso_code | replace: '_','-' | replace: 'en','en_US' -%}
    <meta property="og:locale:alternate" content="{{ og_locale }}">
  {%- endfor -%}
{%- endif -%}

{%- if template.name contains 'product' -%}
  <meta property="product:price:amount" content="{{ product.price | money_without_currency }}">
  <meta property="product:price:currency" content="{{ shop.currency }}">
  <meta property="product:availability" content="{% if product.available %}in stock{% else %}out of stock{% endif %}">
  <meta property="product:brand" content="{{ product.vendor | default: shop.name }}">
{%- endif -%}

{%- comment %} OG Image (1200x630 for social) {%- endcomment -%}
{%- if og_img -%}
  {%- comment -%}
    image_url works for Image objects and image_picker settings.
    Always request 1200x630 for social cards; crop center for consistency.
  {%- endcomment -%}
  <meta property="og:image" content="{{ og_img | image_url: width: 1200, height: 630, crop: 'center' }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="{{ page_title | escape }}">
{%- endif -%}

{%- comment %} Twitter Cards {%- endcomment -%}
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ page_title }}">
<meta name="twitter:description" content="{{ meta_desc | escape }}">
{%- if shop.metafields.social.twitter_handle -%}
  <meta name="twitter:site" content="@{{ shop.metafields.social.twitter_handle }}">
{%- endif -%}
{%- if og_img -%}
  <meta name="twitter:image" content="{{ og_img | image_url: width: 1200, height: 630, crop: 'center' }}">
  <meta name="twitter:image:alt" content="{{ page_title | escape }}">
{%- endif -%}

{%- comment %} Additional Meta for Local Business (homepage emphasis) {%- endcomment -%}
{%- if template.name == 'index' -%}
  <meta property="business:contact_data:street_address" content="1520 SE 46th Ln, Unit B">
  <meta property="business:contact_data:locality" content="Cape Coral">
  <meta property="business:contact_data:region" content="FL">
  <meta property="business:contact_data:postal_code" content="33904">
  <meta property="business:contact_data:country_name" content="USA">
  <meta property="place:location:latitude" content="26.5629">
  <meta property="place:location:longitude" content="-81.9495">
{%- endif -%}

{%- comment %} Alternate for Mobile (optional) {%- endcomment -%}
<link rel="alternate" media="only screen and (max-width: 640px)" href="{{ canonical_url }}">

{%- comment -%}
  Preconnects are fine here; keep fast path for fonts/CDN
{%- endcomment -%}
<link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
