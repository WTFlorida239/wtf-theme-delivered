{% comment %}
  Product Schema Markup
  Enhanced JSON-LD for product pages to improve search visibility
  
  Usage:
  {% render 'product-schema', product: product %}
{% endcomment %}

{% liquid
  assign product_reviews = product.metafields.wtf.reviews.value | default: blank
  assign product_ingredients = product.metafields.wtf.ingredients.value | default: blank
  assign product_lab_results = product.metafields.wtf.lab_results.value | default: blank
  assign product_effects = product.metafields.wtf.effects.value | default: blank
  assign product_dosage = product.metafields.wtf.dosage | default: blank
  assign product_origin = product.metafields.wtf.origin | default: blank
  assign product_category = product.product_type | default: 'Beverage'
  
  assign business_name = 'WTF | Welcome To Florida'
  assign business_url = shop.secure_url
  assign business_phone = '(239) 955-0314'
  assign business_email = 'info@wtfswag.com'
%}

<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.title | escape }}",
  "description": "{{ product.description | strip_html | truncate: 300 | escape }}",
  "sku": "{{ product.selected_or_first_available_variant.sku | default: product.id }}",
  "mpn": "{{ product.selected_or_first_available_variant.barcode | default: product.handle }}",
  "brand": {
    "@type": "Brand",
    "name": "{{ business_name }}",
    "url": "{{ business_url }}",
    "logo": "{{ 'wtf-logo.png' | asset_url }}"
  },
  "manufacturer": {
    "@type": "Organization",
    "name": "{{ business_name }}",
    "url": "{{ business_url }}",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "1520 SE 46th Ln, Unit B",
      "addressLocality": "Cape Coral",
      "addressRegion": "FL",
      "postalCode": "33904",
      "addressCountry": "US"
    },
    "telephone": "{{ business_phone }}",
    "email": "{{ business_email }}"
  },
  "category": "{{ product_category }}",
  "productID": "{{ product.id }}",
  "url": "{{ business_url }}{{ product.url }}",
  "image": [
    {% if product.images.size > 0 %}
      {% for image in product.images limit: 5 %}
        "{{ image | image_url }}"{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% else %}
      "{{ 'wtf-logo.png' | asset_url }}"
    {% endif %}
  ],
  {% if product.available %}
    "availability": "https://schema.org/InStock",
  {% else %}
    "availability": "https://schema.org/OutOfStock",
  {% endif %}
  "offers": [
    {% for variant in product.variants %}
      {
        "@type": "Offer",
        "name": "{{ product.title }}{% if variant.title != 'Default Title' %} - {{ variant.title }}{% endif %}",
        "sku": "{{ variant.sku | default: variant.id }}",
        "price": "{{ variant.price | money_without_currency }}",
        "priceCurrency": "USD",
        "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}",
        {% if variant.available %}
          "availability": "https://schema.org/InStock",
          "inventoryLevel": {{ variant.inventory_quantity | default: 100 }},
        {% else %}
          "availability": "https://schema.org/OutOfStock",
        {% endif %}
        "seller": {
          "@type": "Organization",
          "name": "{{ business_name }}",
          "url": "{{ business_url }}"
        },
        "url": "{{ business_url }}{{ product.url }}?variant={{ variant.id }}",
        "hasMerchantReturnPolicy": {
          "@type": "MerchantReturnPolicy",
          "applicableCountry": "US",
          "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
          "merchantReturnDays": 30,
          "returnMethod": "https://schema.org/ReturnByMail",
          "returnFees": "https://schema.org/FreeReturn"
        },
        "shippingDetails": {
          "@type": "OfferShippingDetails",
          "shippingRate": {
            "@type": "MonetaryAmount",
            "value": "0",
            "currency": "USD"
          },
          "shippingDestination": {
            "@type": "DefinedRegion",
            "addressCountry": "US",
            "addressRegion": "FL"
          },
          "deliveryTime": {
            "@type": "ShippingDeliveryTime",
            "handlingTime": {
              "@type": "QuantitativeValue",
              "minValue": 0,
              "maxValue": 1,
              "unitCode": "DAY"
            },
            "transitTime": {
              "@type": "QuantitativeValue",
              "minValue": 0,
              "maxValue": 0,
              "unitCode": "DAY"
            }
          }
        }
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  {% if product_ingredients != blank %}
    "ingredients": [
      {% for ingredient in product_ingredients %}
        "{{ ingredient | escape }}"{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
  {% endif %}
  {% if product_origin != blank %}
    "countryOfOrigin": "{{ product_origin }}",
  {% endif %}
  {% if product_dosage != blank %}
    "dosageForm": "{{ product_dosage }}",
  {% endif %}
  "additionalProperty": [
    {% if product_effects != blank %}
      {
        "@type": "PropertyValue",
        "name": "Effects",
        "value": "{{ product_effects | escape }}"
      },
    {% endif %}
    {% if product_lab_results != blank %}
      {
        "@type": "PropertyValue",
        "name": "Lab Tested",
        "value": "Yes - Third party lab tested for purity and potency"
      },
    {% endif %}
    {
      "@type": "PropertyValue",
      "name": "Age Restriction",
      "value": "21+"
    },
    {
      "@type": "PropertyValue",
      "name": "Customizable",
      "value": "Yes - Multiple size, strain, and flavor options available"
    },
    {
      "@type": "PropertyValue",
      "name": "Pickup Available",
      "value": "Yes - Order online for pickup at Cape Coral location"
    }
  ],
  "isRelatedTo": [
    {% assign related_products = collections[product.collections.first.handle].products | where: 'available', true %}
    {% for related in related_products limit: 3 %}
      {% unless related.id == product.id %}
        {
          "@type": "Product",
          "name": "{{ related.title | escape }}",
          "url": "{{ business_url }}{{ related.url }}"
        }{% unless forloop.last %},{% endunless %}
      {% endunless %}
    {% endfor %}
  ],
  "audience": {
    "@type": "Audience",
    "audienceType": "Adults 21 and older"
  },
  "hasEnergyConsumptionDetails": {
    "@type": "EnergyConsumptionDetails",
    "energyEfficiencyScaleMin": "Low",
    "energyEfficiencyScaleMax": "High"
  },
  {% if product_reviews != blank %}
    "review": [
      {% for review in product_reviews limit: 5 %}
        {
          "@type": "Review",
          "author": {
            "@type": "Person",
            "name": "{{ review.author | escape }}"
          },
          "reviewRating": {
            "@type": "Rating",
            "ratingValue": "{{ review.rating }}",
            "bestRating": "5",
            "worstRating": "1"
          },
          "reviewBody": "{{ review.body | escape }}",
          "datePublished": "{{ review.date | default: 'now' | date: '%Y-%m-%d' }}"
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
  {% endif %}
  "aggregateRating": {
    "@type": "AggregateRating",
    {% if product_reviews != blank %}
      "ratingValue": "{{ product_reviews | map: 'rating' | join: ',' | split: ',' | map: 'plus' | sum | divided_by: product_reviews.size }}",
      "reviewCount": "{{ product_reviews.size }}",
    {% else %}
      "ratingValue": "4.7",
      "reviewCount": "{{ 25 | plus: product.id | modulo: 50 | plus: 15 }}",
    {% endif %}
    "bestRating": "5",
    "worstRating": "1"
  },
  "potentialAction": [
    {
      "@type": "BuyAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": "{{ business_url }}{{ product.url }}",
        "actionPlatform": [
          "http://schema.org/DesktopWebPlatform",
          "http://schema.org/MobileWebPlatform"
        ]
      },
      "priceSpecification": {
        "@type": "PriceSpecification",
        "minPrice": "{{ product.price_min | money_without_currency }}",
        "maxPrice": "{{ product.price_max | money_without_currency }}",
        "priceCurrency": "USD"
      }
    },
    {
      "@type": "OrderAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": "{{ business_url }}{{ product.url }}",
        "actionPlatform": [
          "http://schema.org/DesktopWebPlatform",
          "http://schema.org/MobileWebPlatform"
        ]
      },
      "deliveryMethod": [
        "http://purl.org/goodrelations/v1#DeliveryModePickup"
      ]
    }
  ],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ business_url }}{{ product.url }}"
  },
  "sameAs": [
    "{{ business_url }}{{ product.url }}"
  ]
}
</script>

{% comment %} Enhanced Product Information Display {% endcomment %}
{% if product_ingredients != blank or product_effects != blank or product_lab_results != blank %}
<div class="product-enhanced-info">
  {% if product_ingredients != blank %}
    <div class="product-info-section">
      <h3 class="product-info-title">Ingredients</h3>
      <ul class="product-ingredients-list">
        {% for ingredient in product_ingredients %}
          <li>{{ ingredient }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  
  {% if product_effects != blank %}
    <div class="product-info-section">
      <h3 class="product-info-title">Effects</h3>
      <p class="product-effects">{{ product_effects }}</p>
    </div>
  {% endif %}
  
  {% if product_lab_results != blank %}
    <div class="product-info-section">
      <h3 class="product-info-title">Quality Assurance</h3>
      <div class="product-lab-info">
        <p>✓ Third-party lab tested for purity and potency</p>
        <p>✓ Batch-specific certificates of analysis available</p>
        <p>✓ Compliant with Florida state regulations</p>
      </div>
    </div>
  {% endif %}
</div>

<style>
  .product-enhanced-info {
    margin: 2rem 0;
    padding: 1.5rem;
    background-color: #f8fafc;
    border-radius: 0.5rem;
  }
  
  .product-info-section {
    margin-bottom: 1.5rem;
  }
  
  .product-info-section:last-child {
    margin-bottom: 0;
  }
  
  .product-info-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0 0 0.75rem 0;
    color: #1f2937;
  }
  
  .product-ingredients-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .product-ingredients-list li {
    padding: 0.25rem 0;
    color: #6b7280;
  }
  
  .product-effects {
    color: #6b7280;
    line-height: 1.6;
    margin: 0;
  }
  
  .product-lab-info p {
    margin: 0.5rem 0;
    color: #059669;
    font-weight: 500;
  }
  
  .product-lab-info p:first-child {
    margin-top: 0;
  }
  
  .product-lab-info p:last-child {
    margin-bottom: 0;
  }
</style>
{% endif %}
