{%- comment -%}
  Kava-specific drink data for collection pages
  Reads product metafields and outputs JSON for JavaScript consumption
  Based on wtf-drink-data.liquid pattern
{%- endcomment -%}

{%- assign pump_limits_json = product.metafields.custom.pump_limits | default: '{"medium":4,"large":6,"gallon":12}' -%}
{%- assign pump_cost = product.metafields.custom.pump_cost | default: 0 -%}

{%- assign flavors_raw = product.metafields.custom.available_flavors | default: '' -%}
{%- if flavors_raw contains '[' and flavors_raw contains ']' -%}
  {%- # theme-check-disable UnknownFilter -%}
  {%- assign flavors_list = flavors_raw | parse_json -%}
  {%- # theme-check-enable UnknownFilter -%}
{%- else -%}
  {%- assign flavors_list = flavors_raw | split: ',' | map: 'strip' -%}
{%- endif -%}

{%- assign variant_map_json = product.metafields.custom.variant_map | default: '{}' -%}
{%- assign shop_hours_json = shop.metafields.custom.business_hours | default: '{}' -%}
{%- assign shop_contact_json = shop.metafields.custom.contact_info | default: '{}' -%}
{%- assign shop_location_meta = shop.metafields.custom.location -%}

<script id="wtf-kava-data" type="application/json">
{
  "productId": {{ product.id | json }},
  "handle": {{ product.handle | json }},
  "title": {{ product.title | json }},
  "category": "kava",
  "variants": [
    {%- for v in product.variants -%}
      {"id": {{ v.id }}, "title": {{ v.title | json }}, "price": {{ v.price | money_without_currency | replace: ',', '' | json }}, "available": {{ v.available | json }} }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  "options": {{ product.options_with_values | json }},
  "pumpLimits": {{ pump_limits_json }},
  "pumpCost": {{ pump_cost | json }},
  "availableFlavors": {{ flavors_list | json }},
  "variantMap": {{ variant_map_json }},
  "shopMeta": {
    "hours": {{ shop_hours_json }},
    "contact": {{ shop_contact_json }},
    "location": {{ shop_location_meta | json }}
  }
}
</script>

