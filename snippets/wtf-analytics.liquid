{%- comment -%}
WTF Analytics & Pixel Tracking - PERFORMANCE OPTIMIZED
Deferred loading for Meta, Google, TikTok, Snapchat, and more
All scripts load after page interaction to improve FCP/LCP
{%- endcomment -%}

<script>
  // Defer all analytics until after page load and user interaction
  (function() {
    let analyticsLoaded = false;
    
    function loadAnalytics() {
      if (analyticsLoaded) return;
      analyticsLoaded = true;
      
      {%- comment -%} Google Analytics 4 {%- endcomment -%}
      {%- if settings.google_analytics_id != blank -%}
        const gaScript = document.createElement('script');
        gaScript.async = true;
        gaScript.src = 'https://www.googletagmanager.com/gtag/js?id={{ settings.google_analytics_id }}';
        document.head.appendChild(gaScript);
        
        gaScript.onload = function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '{{ settings.google_analytics_id }}', {
            'send_page_view': true,
            'enhanced_ecommerce': true,
            'custom_map': {
              'custom_parameter_1': 'strain',
              'custom_parameter_2': 'flavors',
              'custom_parameter_3': 'mix'
            }
          });
        };
      {%- endif -%}
      
      {%- comment -%} Google Ads Conversion Tracking {%- endcomment -%}
      {%- if settings.google_ads_id != blank -%}
        const gadsScript = document.createElement('script');
        gadsScript.async = true;
        gadsScript.src = 'https://www.googletagmanager.com/gtag/js?id={{ settings.google_ads_id }}';
        document.head.appendChild(gadsScript);
        
        gadsScript.onload = function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', '{{ settings.google_ads_id }}');
        };
      {%- endif -%}
      
      {%- comment -%} Meta Pixel (Facebook/Instagram) {%- endcomment -%}
      {%- if settings.facebook_pixel_id != blank -%}
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        
        fbq('init', '{{ settings.facebook_pixel_id }}');
        fbq('track', 'PageView');
      {%- endif -%}
      
      {%- comment -%} TikTok Pixel {%- endcomment -%}
      {%- if settings.tiktok_pixel_id != blank -%}
        !function (w, d, t) {
          w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=i,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};var o=document.createElement("script");o.type="text/javascript",o.async=!0,o.src=i+"?sdkid="+e+"&lib="+t;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};
          ttq.load('{{ settings.tiktok_pixel_id }}');
          ttq.page();
        }(window, document, 'ttq');
      {%- endif -%}
      
      {%- comment -%} Snapchat Pixel {%- endcomment -%}
      {%- if settings.snapchat_pixel_id != blank -%}
        (function(e,t,n){if(e.snaptr)return;var a=e.snaptr=function()
        {a.handleRequest?a.handleRequest.apply(a,arguments):a.queue.push(arguments)};
        a.queue=[];var s='script';r=t.createElement(s);r.async=!0;
        r.src=n;var u=t.getElementsByTagName(s)[0];
        u.parentNode.insertBefore(r,u);})(window,document,
        'https://sc-static.net/scevent.min.js');
        
        snaptr('init', '{{ settings.snapchat_pixel_id }}', {
          'user_email': '__INSERT_USER_EMAIL__'
        });
        snaptr('track', 'PAGE_VIEW');
      {%- endif -%}
      
      {%- comment -%} Pinterest Tag {%- endcomment -%}
      {%- if settings.pinterest_tag_id != blank -%}
        !function(e){if(!window.pintrk){window.pintrk = function () {
        window.pintrk.queue.push(Array.prototype.slice.call(arguments))};var
          n=window.pintrk;n.queue=[],n.version="3.0";var
          t=document.createElement("script");t.async=!0,t.src=e;var
          r=document.getElementsByTagName("script")[0];
          r.parentNode.insertBefore(t,r)}}("https://s.pinimg.com/ct/core.js");
        pintrk('load', '{{ settings.pinterest_tag_id }}', {em: '<user_email_address>'});
        pintrk('page');
      {%- endif -%}
      
      {%- comment -%} Microsoft Clarity {%- endcomment -%}
      {%- if settings.clarity_project_id != blank -%}
        (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "{{ settings.clarity_project_id }}");
      {%- endif -%}
      
      {%- comment -%} Hotjar {%- endcomment -%}
      {%- if settings.hotjar_site_id != blank -%}
        (function(h,o,t,j,a,r){
          h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
          h._hjSettings={hjid:{{ settings.hotjar_site_id }},hjsv:6};
          a=o.getElementsByTagName('head')[0];
          r=o.createElement('script');r.async=1;
          r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
          a.appendChild(r);
        })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
      {%- endif -%}
      
      console.log('[WTF Analytics] All tracking scripts loaded');
    }
    
    // Load analytics after page load + user interaction or after 3 seconds
    const events = ['scroll', 'click', 'mousemove', 'touchstart', 'keydown'];
    const loadOnce = function() {
      loadAnalytics();
      events.forEach(event => window.removeEventListener(event, loadOnce));
    };
    
    // Attach to user interaction events
    events.forEach(event => window.addEventListener(event, loadOnce, { passive: true, once: true }));
    
    // Fallback: load after 3 seconds if no interaction
    window.addEventListener('load', function() {
      setTimeout(loadAnalytics, 3000);
    });
  })();
</script>

{%- comment -%} Noscript fallbacks for pixels {%- endcomment -%}
<noscript>
  {%- if settings.facebook_pixel_id != blank -%}
    <img height="1" width="1" style="display:none" 
         src="https://www.facebook.com/tr?id={{ settings.facebook_pixel_id }}&ev=PageView&noscript=1"
         alt="" loading="lazy"/>
  {%- endif -%}
  {%- if settings.pinterest_tag_id != blank -%}
    <img height="1" width="1" style="display:none;" alt=""
         src="https://ct.pinterest.com/v3/?event=init&tid={{ settings.pinterest_tag_id }}&noscript=1" loading="lazy"/>
  {%- endif -%}
</noscript>
