{%- if product and product.selected_or_first_available_variant -%}
  {%- liquid
    assign selected_variant = product.selected_or_first_available_variant
    assign origin = request.origin | default: shop.url
    assign product_url = origin | append: product.url
    assign product_images = product.media | where: 'media_type', 'image'
    assign brand_name = product.vendor | default: shop.name

    assign price_whole = selected_variant.price | divided_by: 100
    assign price_cents = selected_variant.price | modulo: 100
    capture price_string
      {{- price_whole -}}.{%- if price_cents < 10 -%}0{%- endif -%}{{- price_cents -}}
    endcapture
    assign price_string = price_string | strip

    assign compare_at_string = ''
    if selected_variant.compare_at_price and selected_variant.compare_at_price > selected_variant.price
      assign compare_whole = selected_variant.compare_at_price | divided_by: 100
      assign compare_cents = selected_variant.compare_at_price | modulo: 100
      capture compare_value
        {{- compare_whole -}}.{%- if compare_cents < 10 -%}0{%- endif -%}{{- compare_cents -}}
      endcapture
      assign compare_at_string = compare_value | strip
    endif

    assign barcode = selected_variant.barcode | strip
    assign gtin_property = ''
    if barcode != blank
      case barcode.size
        when 8
          assign gtin_property = '"gtin8": ' | append: (barcode | json)
        when 12
          assign gtin_property = '"gtin12": ' | append: (barcode | json)
        when 13
          assign gtin_property = '"gtin13": ' | append: (barcode | json)
        when 14
          assign gtin_property = '"gtin14": ' | append: (barcode | json)
        else
          assign gtin_property = '"gtin": ' | append: (barcode | json)
      endcase
    endif

    assign inventory_level_fragment = ''
    if selected_variant.inventory_management != blank and selected_variant.inventory_quantity != null
      assign inventory_quantity = selected_variant.inventory_quantity
      if inventory_quantity < 0
        assign inventory_quantity = 0
      endif
      capture inventory_json
        "inventoryLevel": {
          "@type": "QuantitativeValue",
          "value": {{ inventory_quantity | json }}
        }
      endcapture
      assign inventory_level_fragment = inventory_json | strip
    endif

    assign rating_fragment = ''
    if product.rating_count and product.rating_count > 0 and product.rating_value
      capture rating_json
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": {{ product.rating_value | json }},
          "reviewCount": {{ product.rating_count | json }}
        }
      endcapture
      assign rating_fragment = rating_json | strip
    endif

    assign image_fragment = ''
    if product_images.size > 0
      capture images_json
        "image": [
          {%- for media in product_images limit: 10 -%}
            {{ media | image_url: width: 1200 | json }}{%- unless forloop.last -%}, {% endunless -%}
          {%- endfor -%}
        ]
      endcapture
      assign image_fragment = images_json | strip
    endif
  -%}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "@id": {{ product_url | append: '#Product' | json }},
      "url": {{ product_url | json }},
      "name": {{ product.title | json }},
      {%- if product.description != blank -%}
      "description": {{ product.description | strip_html | truncate: 500 | json }},
      {%- endif -%}
      {%- if selected_variant.sku != blank -%}
      "sku": {{ selected_variant.sku | json }},
      {%- endif -%}
      "productID": {{ product.id | json }},
      "brand": {
        "@type": "Brand",
        "name": {{ brand_name | json }}
      },
      {%- if product.product_type != blank -%}
      "category": {{ product.product_type | json }},
      {%- endif -%}
      {%- if image_fragment != blank -%}
      {{ image_fragment }},
      {%- endif -%}
      "offers": {
        "@type": "Offer",
        "@id": {{ product_url | append: '#Offer-' | append: selected_variant.id | json }},
        "priceCurrency": {{ shop.currency | json }},
        "price": {{ price_string | json }},
        "availability": "https://schema.org/{% if selected_variant.available %}InStock{% else %}OutOfStock{% endif %}",
        "url": {{ product_url | json }},
        "itemCondition": "https://schema.org/NewCondition",
        "seller": {
          "@type": "Organization",
          "name": {{ shop.name | json }}
        }
        {%- if selected_variant.sku != blank -%},
        "sku": {{ selected_variant.sku | json }}
        {%- endif -%}
        {%- if compare_at_string != blank -%},
        "priceSpecification": {
          "@type": "UnitPriceSpecification",
          "price": {{ compare_at_string | json }},
          "priceCurrency": {{ shop.currency | json }},
          "priceType": "https://schema.org/OriginalPrice"
        }
        {%- endif -%}
        {%- if inventory_level_fragment != blank -%},
        {{ inventory_level_fragment }}
        {%- endif -%}
      }
      {%- if gtin_property != blank -%},
      {{ gtin_property }}
      {%- endif -%}
      {%- if product.metafields.seo and product.metafields.seo.mpn != blank -%},
      "mpn": {{ product.metafields.seo.mpn | json }}
      {%- endif -%}
      {%- if rating_fragment != blank -%},
      {{ rating_fragment }}
      {%- endif -%}
    }
  </script>
{%- endif -%}
